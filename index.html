<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Performance Monitoring</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111827',
                            card: '#1f2937',
                            text: '#f3f4f6',
                            muted: '#9ca3af',
                            border: '#374151'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="fontawesome/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="assets/css/shared-styles.css">
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden dark:bg-dark-bg dark:text-dark-text">

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 h-16 flex-none z-10 dark:bg-dark-card dark:border-dark-border">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between h-full">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-3">
                        <div class="bg-blue-600 text-white p-2 rounded-lg">
                            <i class="fa-solid fa-network-wired text-xl"></i>
                        </div>
                        <span class="font-bold text-xl tracking-tight text-gray-900 dark:text-white">Network Performance Monitoring</span>
                    </div>
                    <div class="hidden sm:ml-8 sm:flex sm:space-x-8">
                        <a href="index.html" class="border-blue-500 text-gray-900 dark:text-white inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Summary Page</a>
                        <a href="sdwan.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">SD-WAN Page</a>
                        <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Switch Page</a>
                        <a href="#" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Access Point Page</a>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Scope Selector -->
                    <div class="relative">
                        <select id="scopeSelector" onchange="updateDashboardScope(this.value)" class="block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-gray-50 border dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="Global">Global Organization</option>
                            <optgroup label="Regions">
                                <option value="North America">North America</option>
                                <option value="EMEA">EMEA</option>
                                <option value="APAC">APAC</option>
                            </optgroup>
                            <optgroup label="Sites">
                                <option value="site:NYC-HQ">NYC-HQ</option>
                                <option value="site:LON-Warehouse">LON-Warehouse</option>
                                <option value="site:SFO-Branch">SFO-Branch</option>
                                <option value="site:TOK-Sales">TOK-Sales</option>
                                <option value="site:MUM-Hub">MUM-Hub</option>
                                <option value="site:ATL-Retail">ATL-Retail</option>
                                <option value="site:CHI-Dist">CHI-Dist</option>
                                <option value="site:BER-R&D">BER-R&D</option>
                                <option value="site:PAR-Office">PAR-Office</option>
                                <option value="site:SYD-Office">SYD-Office</option>
                                <option value="site:BRA-Remote">BRA-Remote</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="themeToggle" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 focus:outline-none">
                        <i class="fa-solid fa-moon dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
                    </button>

                    <div class="flex items-center gap-3 border-l pl-4 border-gray-200 dark:border-gray-700">
                        <div class="text-right hidden md:block">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Admin User</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">NetOps Lead</p>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">
                            AU
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Backdrop for expanded widget -->
    <div id="expandedBackdrop" onclick="closeExpandedWidgets()"></div>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-dark-bg">

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-12 gap-6 max-w-[1920px] mx-auto">

            <!-- 1. Executive Summary / Global Health (Top Left) -->
            <div class="col-span-12 lg:col-span-3 card p-4 relative h-64 bg-white dark:bg-dark-card">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white">Network Health</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                        Live
                    </span>
                </div>
                <div class="relative h-full flex items-center justify-center pb-2">
                    <canvas id="healthGauge"></canvas>
                    <div class="gauge-value text-gray-800 dark:text-white" id="healthScoreValue">--</div>
                    <div class="gauge-label text-gray-500 dark:text-gray-400">Weighted Score</div>
                    <div class="absolute bottom-4 left-0 right-0 flex justify-between text-xs text-gray-400 px-8">
                        <span>Critical</span>
                        <span>Healthy</span>
                    </div>
                </div>
            </div>

            <!-- 2. Network Issues & Security Posture -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-3 flex flex-col gap-6 h-64">
                <!-- Network Issues -->
                <div id="networkIssuesCard" class="card p-4 flex-1 flex flex-col justify-center bg-white dark:bg-dark-card overflow-hidden">
                    <div id="issuesSummaryView">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <h3 class="text-sm font-bold text-gray-700 dark:text-white">Network Issues</h3>
                            <span class="text-[10px] text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 px-1.5 py-0.5 rounded flex items-center gap-1">
                                <i class="fa-solid fa-hand-pointer text-[7px]"></i> Click
                            </span>
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <div class="cursor-pointer group flex-1 text-center" onclick="showIssuesAlerts('crit')">
                                <span class="block text-2xl font-bold text-red-600 group-hover:text-red-500 transition-colors" id="criticalCount">--</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 border-b border-dashed border-gray-400 group-hover:border-red-500 inline-block">Critical</span>
                            </div>
                            <div class="flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-triangle-exclamation text-4xl text-red-600 opacity-30 dark:opacity-90"></i>
                            </div>
                            <div class="cursor-pointer group flex-1 text-center" onclick="showIssuesAlerts('warn')">
                                <span class="block text-2xl font-bold text-amber-500 group-hover:text-amber-400 transition-colors" id="warningCount">--</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 border-b border-dashed border-gray-400 group-hover:border-amber-500 inline-block">Warning</span>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Alert Feed View (Initially Hidden) -->
                    <div id="issuesExpandedView" class="hidden h-full flex flex-col">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <button onclick="hideIssuesAlerts()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                    <i class="fa-solid fa-arrow-left text-sm"></i>
                                </button>
                                <h4 class="text-base font-bold text-gray-700 dark:text-white" id="issuesAlertTitle">Network Alerts</h4>
                                <span class="text-xs text-gray-400 dark:text-gray-500" id="issuesAlertCount"></span>
                            </div>
                            <!-- Severity Filter -->
                            <div class="flex gap-2">
                                <button onclick="filterIssuesAlerts('all')" id="issuesFilterAll" class="px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">All</button>
                                <button onclick="filterIssuesAlerts('crit')" id="issuesFilterCrit" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Critical</button>
                                <button onclick="filterIssuesAlerts('warn')" id="issuesFilterWarn" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Warning</button>
                                <button onclick="filterIssuesAlerts('info')" id="issuesFilterInfo" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Info</button>
                            </div>
                        </div>
                        <!-- Search Input -->
                        <div class="mb-3">
                            <input type="text" id="issuesSearchInput" placeholder="Search alerts by site, device, or message..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="searchIssuesAlerts()">
                        </div>
                        <!-- Alert Table -->
                        <div class="flex-1 overflow-auto custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Severity</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Time</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Device</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Message</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700" id="issuesAlertTableBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Security -->
                <div id="securityCard" class="card p-4 flex-1 flex flex-col justify-center bg-white dark:bg-dark-card overflow-hidden">
                    <div id="securitySummaryView">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <h3 class="text-sm font-bold text-gray-700 dark:text-white">Security Posture (24h)</h3>
                            <span class="text-[10px] text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 px-1.5 py-0.5 rounded flex items-center gap-1">
                                <i class="fa-solid fa-hand-pointer text-[7px]"></i> Click
                            </span>
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <div class="cursor-pointer group flex-1 text-center" onclick="showSecurityAlerts('threat')">
                                <span class="block text-2xl font-bold text-gray-900 dark:text-white group-hover:text-indigo-600 transition-colors" id="threatsCount">--</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 border-b border-dashed border-gray-400 group-hover:border-indigo-600 inline-block">Threats Blocked</span>
                            </div>
                            <div class="flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-shield-halved text-4xl text-indigo-600 dark:text-indigo-400 opacity-30 dark:opacity-90"></i>
                            </div>
                            <div class="cursor-pointer group flex-1 text-center" onclick="showSecurityAlerts('rogue')">
                                <span class="block text-2xl font-bold text-red-600 group-hover:text-red-500 transition-colors" id="roguesCount">--</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 border-b border-dashed border-gray-400 group-hover:border-red-500 inline-block">Active Rogues</span>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Security Alert Feed View (Initially Hidden) -->
                    <div id="securityExpandedView" class="hidden h-full flex flex-col">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <button onclick="hideSecurityAlerts()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                    <i class="fa-solid fa-arrow-left text-sm"></i>
                                </button>
                                <h4 class="text-base font-bold text-gray-700 dark:text-white" id="securityAlertTitle">Security Alerts</h4>
                                <span class="text-xs text-gray-400 dark:text-gray-500" id="securityAlertCount"></span>
                            </div>
                            <!-- Security Type Filter -->
                            <div class="flex gap-2">
                                <button onclick="filterSecurityAlerts('all')" id="securityFilterAll" class="px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">All</button>
                                <button onclick="filterSecurityAlerts('threat')" id="securityFilterThreat" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Threats</button>
                                <button onclick="filterSecurityAlerts('rogue')" id="securityFilterRogue" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Rogues</button>
                            </div>
                        </div>
                        <!-- Search Input -->
                        <div class="mb-3">
                            <input type="text" id="securitySearchInput" placeholder="Search security alerts by site, device, or message..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="searchSecurityAlerts()">
                        </div>
                        <!-- Alert Table -->
                        <div class="flex-1 overflow-auto custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Time</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Device</th>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Message</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700" id="securityAlertTableBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Active Clients by Device Type -->
            <div id="activeClientsCard" class="col-span-12 sm:col-span-6 lg:col-span-2 card p-3 h-64 bg-white dark:bg-dark-card overflow-hidden">
                <div class="flex items-baseline gap-2 mb-3">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white">Active Clients</h3>
                    <span class="text-[10px] text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 px-1.5 py-0.5 rounded flex items-center gap-1">
                        <i class="fa-solid fa-hand-pointer text-[7px]"></i> Click rows
                    </span>
                    <button id="expandToggle" class="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" onclick="toggleExpand()">
                        <i class="fa-solid fa-expand text-xs"></i>
                    </button>
                </div>
                <div id="summaryView" class="flex flex-col justify-between h-[calc(100%-2rem)]">
                    <!-- Gateways -->
                    <div class="flex flex-col gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded transition-colors" onclick="showDeviceList('gateway')">
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-network-wired text-blue-600 text-xs"></i>
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Gateways</span>
                            <i class="fa-solid fa-chevron-right text-[8px] text-gray-400 ml-auto"></i>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-gray-900 dark:text-white w-14 flex-shrink-0" id="gwClientCount">3,200</span>
                            <span class="text-[10px] text-green-600 dark:text-green-400 font-medium bg-green-50 dark:bg-green-900/30 px-1 py-0.5 rounded flex items-center gap-0.5 whitespace-nowrap flex-shrink-0">
                                <i class="fa-solid fa-arrow-trend-up"></i> <span id="gwClientTrend">2.1%</span>
                            </span>
                            <div class="flex-1 h-4 min-w-0">
                                <canvas id="gwSparkline"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Switches -->
                    <div class="flex flex-col gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded transition-colors" onclick="showDeviceList('switch')">
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-server text-purple-600 text-xs"></i>
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Switches</span>
                            <i class="fa-solid fa-chevron-right text-[8px] text-gray-400 ml-auto"></i>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-gray-900 dark:text-white w-14 flex-shrink-0" id="swClientCount">7,800</span>
                            <span class="text-[10px] text-green-600 dark:text-green-400 font-medium bg-green-50 dark:bg-green-900/30 px-1 py-0.5 rounded flex items-center gap-0.5 whitespace-nowrap flex-shrink-0">
                                <i class="fa-solid fa-arrow-trend-up"></i> <span id="swClientTrend">5.3%</span>
                            </span>
                            <div class="flex-1 h-4 min-w-0">
                                <canvas id="swSparkline"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Access Points -->
                    <div class="flex flex-col gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded transition-colors" onclick="showDeviceList('ap')">
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-wifi text-green-600 text-xs"></i>
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Access Points</span>
                            <i class="fa-solid fa-chevron-right text-[8px] text-gray-400 ml-auto"></i>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-gray-900 dark:text-white w-14 flex-shrink-0" id="apClientCount">4,342</span>
                            <span class="text-[10px] text-green-600 dark:text-green-400 font-medium bg-green-50 dark:bg-green-900/30 px-1 py-0.5 rounded flex items-center gap-0.5 whitespace-nowrap flex-shrink-0">
                                <i class="fa-solid fa-arrow-trend-up"></i> <span id="apClientTrend">3.7%</span>
                            </span>
                            <div class="flex-1 h-4 min-w-0">
                                <canvas id="apSparkline"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expanded Device List View (Initially Hidden) -->
                <div id="expandedView" class="hidden h-[calc(100%-2rem)] flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <button onclick="hideDeviceList()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                <i class="fa-solid fa-arrow-left text-sm"></i>
                            </button>
                            <h4 class="text-base font-bold text-gray-700 dark:text-white" id="deviceListTitle">Devices</h4>
                            <span class="text-xs text-gray-400 dark:text-gray-500" id="deviceCount"></span>
                        </div>
                        <!-- Device Type Filter -->
                        <div class="flex gap-2">
                            <button onclick="filterDevices('all')" id="filterAll" class="px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">All</button>
                            <button onclick="filterDevices('gateway')" id="filterGateway" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Gateways</button>
                            <button onclick="filterDevices('switch')" id="filterSwitch" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Switches</button>
                            <button onclick="filterDevices('ap')" id="filterAp" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Access Points</button>
                        </div>
                    </div>
                    <!-- Search Input -->
                    <div class="mb-3">
                        <input type="text" id="clientsSearchInput" placeholder="Search devices by name, site, or IP address..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="searchDeviceList()">
                    </div>
                    <!-- Device List -->
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <div id="deviceListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Device items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

             <!-- 4. Device Status Distribution (Status Matrix) -->
             <div id="deviceStatusCard" class="col-span-12 sm:col-span-6 lg:col-span-4 card p-4 h-64 bg-white dark:bg-dark-card overflow-hidden">
                <div id="statusSummaryView" class="h-full flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-gray-700 dark:text-white">Device Status Distribution</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded flex items-center gap-1">
                                <i class="fa-solid fa-hand-pointer text-[8px]"></i> Click cells
                            </span>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center">
                        <div class="status-grid border border-gray-200 dark:border-gray-700">
                            <!-- Header Row -->
                            <div class="status-cell status-header">Type</div>
                            <div class="status-cell status-header text-green-600 dark:text-green-400">Online</div>
                            <div class="status-cell status-header text-amber-500">Warning</div>
                            <div class="status-cell status-header text-red-500">Critical</div>

                            <!-- Gateways -->
                            <div class="status-cell font-medium text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800">Gateways</div>
                            <div class="status-cell clickable" id="gw-online" onclick="showStatusDevices('gateway', 'online')">--</div>
                            <div class="status-cell clickable bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400" id="gw-warn" onclick="showStatusDevices('gateway', 'warning')">--</div>
                            <div class="status-cell clickable bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400 font-bold" id="gw-crit" onclick="showStatusDevices('gateway', 'critical')">--</div>

                            <!-- Switches -->
                            <div class="status-cell font-medium text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800">Switches</div>
                            <div class="status-cell clickable" id="sw-online" onclick="showStatusDevices('switch', 'online')">--</div>
                            <div class="status-cell clickable bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400" id="sw-warn" onclick="showStatusDevices('switch', 'warning')">--</div>
                            <div class="status-cell clickable bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400 font-bold" id="sw-crit" onclick="showStatusDevices('switch', 'critical')">--</div>

                            <!-- APs -->
                            <div class="status-cell font-medium text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800">Access Points</div>
                            <div class="status-cell clickable" id="ap-online" onclick="showStatusDevices('ap', 'online')">--</div>
                            <div class="status-cell clickable bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400" id="ap-warn" onclick="showStatusDevices('ap', 'warning')">--</div>
                            <div class="status-cell clickable bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400 font-bold" id="ap-crit" onclick="showStatusDevices('ap', 'critical')">--</div>
                        </div>
                    </div>
                </div>

                <!-- Expanded Status Device List View (Initially Hidden) -->
                <div id="statusExpandedView" class="hidden h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <button onclick="hideStatusDevices()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                <i class="fa-solid fa-arrow-left text-sm"></i>
                            </button>
                            <h4 class="text-base font-bold text-gray-700 dark:text-white" id="statusDeviceListTitle">Devices</h4>
                            <span class="text-xs text-gray-400 dark:text-gray-500" id="statusDeviceCount"></span>
                        </div>
                        <!-- Status Filter -->
                        <div class="flex gap-2">
                            <button onclick="filterStatusDevices('all')" id="statusFilterAll" class="px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">All</button>
                            <button onclick="filterStatusDevices('online')" id="statusFilterOnline" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Online</button>
                            <button onclick="filterStatusDevices('warning')" id="statusFilterWarning" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Warning</button>
                            <button onclick="filterStatusDevices('critical')" id="statusFilterCritical" class="px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Critical</button>
                        </div>
                    </div>
                    <!-- Search Input -->
                    <div class="mb-3">
                        <input type="text" id="statusSearchInput" placeholder="Search devices by name, site, or IP address..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="searchStatusDevices()">
                    </div>
                    <!-- Device List -->
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <div id="statusDeviceListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Device items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 2: Analytical Charts -->

            <!-- 7. Top Impacted SD-WANs (Latency) -->
            <div class="col-span-12 lg:col-span-4 card p-4 h-80 bg-white dark:bg-dark-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white">Top Impacted SD-WANs (Latency)</h3>
                    <span class="text-xs text-gray-400">Avg WAN Latency (ms)</span>
                </div>
                <div class="relative h-full w-full pb-4">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>

            <!-- 6. User Frustration Leaderboard -->
            <div class="col-span-12 lg:col-span-5 card p-4 h-80 bg-white dark:bg-dark-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white">User Frustration Leaderboard</h3>
                    <span class="text-xs text-gray-400">Time to Connect (ms)</span>
                </div>
                <div class="relative h-full w-full pb-4">
                    <canvas id="frustrationChart"></canvas>
                </div>
            </div>

            <!-- 8. WAN Resilience (Donut) -->
            <div class="col-span-12 lg:col-span-3 card p-4 h-80 bg-white dark:bg-dark-card flex flex-col">
                <div class="flex justify-center items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white">WAN Resilience</h3>
                </div>
                <div class="relative flex-1 flex items-center justify-center overflow-hidden px-2">
                    <div class="relative w-full" style="max-width: 231px; max-height: 231px; aspect-ratio: 1/1;">
                        <canvas id="wanDonut"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <div class="bg-white dark:bg-dark-card rounded-lg p-3 shadow-sm space-y-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Primary</span>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white" id="wanPrimary">91%</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Failover</span>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white" id="wanFailover">8%</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Down</span>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white" id="wanDown">1%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 3: Unified Alert Feed -->
            <div class="col-span-12 card h-96 flex flex-col bg-white dark:bg-dark-card">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-white flex items-center gap-2">
                        <i class="fa-regular fa-bell"></i> Unified Alert Feed
                        <span id="activeFilterBadge" class="hidden ml-2 px-2 py-0.5 rounded text-xs font-normal bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            Filtered
                        </span>
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" placeholder="Search alerts..." class="text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:outline-none focus:border-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <button class="text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 px-3 py-1 rounded">Export CSV</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto custom-scrollbar p-0">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Severity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vendor</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Site</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Device</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Message</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700" id="alertTableBody">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="p-2 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-xs text-center text-gray-500 dark:text-gray-400">
                    Streaming live events...
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-8 mb-4 text-center text-xs text-gray-400 dark:text-gray-500">
            <p>NPM 2.0 Operational Command Center â€¢ Powered by Meraki & Mist Integration</p>
        </footer>
    </main>

    <!-- Import shared modules -->
    <script src="assets/js/theme-manager.js"></script>
    <script src="assets/js/chart-config.js"></script>
    <script src="assets/js/navigation.js"></script>

    <!-- Script for Logic and Charts -->
    <script>
        // Initialize navigation for Summary page
        NavigationManager.init('summary');


        // --- 1. DATA CONFIGURATION & STATE MANAGEMENT ---

        // Scope Definition
        const REGIONS = {
            "Global": { deviceCount: 20000, clientCount: 15342, health: 91, trend: '4.2%' },
            "North America": { deviceCount: 9000, clientCount: 6240, health: 94, trend: '1.2%' },
            "EMEA": { deviceCount: 7000, clientCount: 5100, health: 88, trend: '-2.1%' },
            "APAC": { deviceCount: 4000, clientCount: 4002, health: 92, trend: '0.8%' }
        };

        // Site to Region Mapping
        const SITE_TO_REGION = {
            'NYC-HQ': 'North America',
            'SFO-Branch': 'North America',
            'ATL-Retail': 'North America',
            'CHI-Dist': 'North America',
            'BRA-Remote': 'North America',
            'LON-Warehouse': 'EMEA',
            'BER-R&D': 'EMEA',
            'PAR-Office': 'EMEA',
            'TOK-Sales': 'APAC',
            'MUM-Hub': 'APAC',
            'SYD-Office': 'APAC'
        };

        // Site-specific data (mock data for each site)
        const SITES = {
            'NYC-HQ': { deviceCount: 1200, clientCount: 980, health: 89, trend: '2.1%' },
            'LON-Warehouse': { deviceCount: 800, clientCount: 650, health: 85, trend: '-1.5%' },
            'SFO-Branch': { deviceCount: 600, clientCount: 480, health: 92, trend: '3.2%' },
            'TOK-Sales': { deviceCount: 500, clientCount: 420, health: 91, trend: '1.8%' },
            'MUM-Hub': { deviceCount: 900, clientCount: 750, health: 88, trend: '0.5%' },
            'ATL-Retail': { deviceCount: 400, clientCount: 320, health: 94, trend: '2.5%' },
            'CHI-Dist': { deviceCount: 700, clientCount: 560, health: 93, trend: '1.2%' },
            'BER-R&D': { deviceCount: 650, clientCount: 520, health: 87, trend: '-0.8%' },
            'PAR-Office': { deviceCount: 550, clientCount: 440, health: 90, trend: '1.5%' },
            'SYD-Office': { deviceCount: 450, clientCount: 380, health: 95, trend: '2.8%' },
            'BRA-Remote': { deviceCount: 300, clientCount: 240, health: 82, trend: '-2.3%' }
        };

        // Chart Data Sources (with region mapping)
        // Values represent Time to Connect in milliseconds (higher = worse)
        const frustrationData = [
            { label: 'NYC-HQ (Mist)', region: 'North America', val: 3200, color: '#ef4444' },
            { label: 'LON-Warehouse (Meraki)', region: 'EMEA', val: 2800, color: '#f87171' },
            { label: 'SFO-Branch (Meraki)', region: 'North America', val: 2400, color: '#fca5a5' },
            { label: 'TOK-Sales (Mist)', region: 'APAC', val: 2100, color: '#fbbf24' },
            { label: 'MUM-Hub (Meraki)', region: 'APAC', val: 1900, color: '#fbbf24' },
            { label: 'ATL-Retail (Meraki)', region: 'North America', val: 1600, color: '#fcd34d' },
            { label: 'CHI-Dist (Mist)', region: 'North America', val: 1400, color: '#fcd34d' },
            { label: 'BER-R&D (Mist)', region: 'EMEA', val: 2600, color: '#fca5a5' },
            { label: 'PAR-Office (Meraki)', region: 'EMEA', val: 2200, color: '#fbbf24' },
            { label: 'SYD-Office (Mist)', region: 'APAC', val: 1200, color: '#fcd34d' }
        ];

        const latencyData = [
            { label: 'BRA-Remote (Starlink)', region: 'North America', val: 320, color: '#6366f1' }, // Americas grouped to NA for simplicity
            { label: 'SYD-Office (Fiber)', region: 'APAC', val: 180, color: '#6366f1' },
            { label: 'CHI-Dist (MPLS)', region: 'North America', val: 145, color: '#6366f1' },
            { label: 'BER-R&D (VPN)', region: 'EMEA', val: 110, color: '#6366f1' },
            { label: 'ATL-Retail (LTE)', region: 'North America', val: 95, color: '#6366f1' },
            { label: 'LON-Warehouse (Broadband)', region: 'EMEA', val: 85, color: '#6366f1' },
            { label: 'TOK-Sales (Fiber)', region: 'APAC', val: 45, color: '#6366f1' }
        ];

        // Alerts Data Source (with region)
        const allAlerts = [
            { sev: 'crit', vendor: 'mist', site: 'NYC-HQ', region: 'North America', device: 'Core-Switch-01', msg: 'BGP Neighbor Down (Peer 10.10.10.1)', time: '2m ago', type: 'network' },
            { sev: 'crit', vendor: 'meraki', site: 'LON-Warehouse', region: 'EMEA', device: 'MX-Edge-Gateway', msg: 'Uplink 1 (WAN) detected packet loss > 15%', time: '5m ago', type: 'network' },
            { sev: 'warn', vendor: 'meraki', site: 'SFO-Branch', region: 'North America', device: 'MR-AP-Floor2', msg: 'High Interference detected on Channel 6', time: '12m ago', type: 'network' },
            { sev: 'warn', vendor: 'mist', site: 'TOK-Sales', region: 'APAC', device: 'AP-ConfRoom', msg: 'SLE: Time to Connect exceeded threshold', time: '18m ago', type: 'network' },
            { sev: 'crit', vendor: 'meraki', site: 'MUM-Hub', region: 'APAC', device: 'MS-Dist-Switch', msg: 'Power Supply Unit 2 Fail', time: '25m ago', type: 'hardware' },
            { sev: 'info', vendor: 'meraki', site: 'BER-R&D', region: 'EMEA', device: 'Network', msg: 'Firmware upgrade scheduled for 02:00 UTC', time: '1h ago', type: 'system' },
            { sev: 'warn', vendor: 'mist', site: 'NYC-HQ', region: 'North America', device: 'Gateway-02', msg: 'DHCP Pool Exhaustion approaching (85%)', time: '1h 10m ago', type: 'network' },
            { sev: 'info', vendor: 'mist', site: 'SYD-Office', region: 'APAC', device: 'AP-Lobby', msg: 'Rogue AP detected (SSID: FreeWifi)', time: '1h 30m ago', type: 'rogue' },
            { sev: 'crit', vendor: 'meraki', site: 'ATL-Retail', region: 'North America', device: 'MX-Sec', msg: 'Malware blocked (Trojan.Win32.Emotet)', time: '1h 45m ago', type: 'threat' }
        ];

        // Global Chart Instances
        let charts = {};
        let currentFilter = 'all'; // Alert filter (active fires, threats, etc)
        let currentScope = 'Global'; // Region Scope
        let currentSiteFilter = null; // Site-specific filter
        let isExpanded = false; // Track if Active Clients widget is expanded
        let currentDeviceFilter = 'all'; // Track current device type filter
        let isStatusExpanded = false; // Track if Status widget is expanded
        let currentStatusDeviceType = 'all'; // Track device type for status view
        let currentStatusFilter = 'all'; // Track status filter (online/warning/critical)
        let isIssuesExpanded = false; // Track if Network Issues widget is expanded
        let currentIssuesSeverity = 'all'; // Track severity filter for issues view
        let isSecurityExpanded = false; // Track if Security widget is expanded
        let currentSecurityType = 'all'; // Track security type filter (threat/rogue)
        let issuesSearchTerm = ''; // Search term for issues
        let securitySearchTerm = ''; // Search term for security alerts
        let clientsSearchTerm = ''; // Search term for client devices
        let statusSearchTerm = ''; // Search term for status devices

        // Mock Device Data
        const MOCK_DEVICES = {
            gateway: [
                { name: 'GW-NYC-Core-01', site: 'NYC-HQ', ip: '10.1.1.1', clients: 450, status: 'online', vendor: 'meraki' },
                { name: 'GW-NYC-Edge-02', site: 'NYC-HQ', ip: '10.1.1.2', clients: 320, status: 'online', vendor: 'mist' },
                { name: 'GW-LON-Main', site: 'LON-Warehouse', ip: '10.2.1.1', clients: 280, status: 'warning', vendor: 'meraki' },
                { name: 'GW-SFO-Branch', site: 'SFO-Branch', ip: '10.3.1.1', clients: 190, status: 'online', vendor: 'meraki' },
                { name: 'GW-TOK-Primary', site: 'TOK-Sales', ip: '10.4.1.1', clients: 210, status: 'online', vendor: 'mist' },
                { name: 'GW-MUM-Hub-01', site: 'MUM-Hub', ip: '10.5.1.1', clients: 380, status: 'online', vendor: 'meraki' },
                { name: 'GW-ATL-Retail', site: 'ATL-Retail', ip: '10.6.1.1', clients: 150, status: 'online', vendor: 'meraki' },
                { name: 'GW-CHI-Dist', site: 'CHI-Dist', ip: '10.7.1.1', clients: 240, status: 'warning', vendor: 'mist' },
                { name: 'GW-BER-R&D', site: 'BER-R&D', ip: '10.8.1.1', clients: 200, status: 'online', vendor: 'mist' },
                { name: 'GW-PAR-Office', site: 'PAR-Office', ip: '10.9.1.1', clients: 170, status: 'online', vendor: 'meraki' },
                { name: 'GW-SYD-Office', site: 'SYD-Office', ip: '10.10.1.1', clients: 160, status: 'online', vendor: 'mist' },
                { name: 'GW-BRA-Remote', site: 'BRA-Remote', ip: '10.11.1.1', clients: 90, status: 'critical', vendor: 'meraki' }
            ],
            switch: [
                { name: 'SW-NYC-Core-01', site: 'NYC-HQ', ip: '10.1.2.1', clients: 890, status: 'online', vendor: 'meraki' },
                { name: 'SW-NYC-Floor2', site: 'NYC-HQ', ip: '10.1.2.2', clients: 620, status: 'online', vendor: 'meraki' },
                { name: 'SW-NYC-Floor3', site: 'NYC-HQ', ip: '10.1.2.3', clients: 540, status: 'warning', vendor: 'mist' },
                { name: 'SW-LON-Dist-01', site: 'LON-Warehouse', ip: '10.2.2.1', clients: 720, status: 'online', vendor: 'meraki' },
                { name: 'SW-LON-Dist-02', site: 'LON-Warehouse', ip: '10.2.2.2', clients: 580, status: 'online', vendor: 'mist' },
                { name: 'SW-SFO-Access', site: 'SFO-Branch', ip: '10.3.2.1', clients: 430, status: 'online', vendor: 'meraki' },
                { name: 'SW-TOK-Core', site: 'TOK-Sales', ip: '10.4.2.1', clients: 490, status: 'online', vendor: 'mist' },
                { name: 'SW-MUM-Dist', site: 'MUM-Hub', ip: '10.5.2.1', clients: 810, status: 'critical', vendor: 'meraki' },
                { name: 'SW-MUM-Access', site: 'MUM-Hub', ip: '10.5.2.2', clients: 650, status: 'online', vendor: 'meraki' },
                { name: 'SW-ATL-Main', site: 'ATL-Retail', ip: '10.6.2.1', clients: 380, status: 'online', vendor: 'meraki' },
                { name: 'SW-CHI-Core', site: 'CHI-Dist', ip: '10.7.2.1', clients: 560, status: 'online', vendor: 'mist' },
                { name: 'SW-BER-Lab', site: 'BER-R&D', ip: '10.8.2.1', clients: 470, status: 'online', vendor: 'mist' },
                { name: 'SW-PAR-Main', site: 'PAR-Office', ip: '10.9.2.1', clients: 410, status: 'online', vendor: 'meraki' },
                { name: 'SW-SYD-Core', site: 'SYD-Office', ip: '10.10.2.1', clients: 360, status: 'online', vendor: 'mist' },
                { name: 'SW-BRA-Access', site: 'BRA-Remote', ip: '10.11.2.1', clients: 220, status: 'warning', vendor: 'meraki' }
            ],
            ap: [
                { name: 'AP-NYC-Floor1-01', site: 'NYC-HQ', ip: '10.1.3.1', clients: 45, status: 'online', vendor: 'mist' },
                { name: 'AP-NYC-Floor1-02', site: 'NYC-HQ', ip: '10.1.3.2', clients: 38, status: 'online', vendor: 'mist' },
                { name: 'AP-NYC-Floor2-01', site: 'NYC-HQ', ip: '10.1.3.3', clients: 52, status: 'online', vendor: 'mist' },
                { name: 'AP-NYC-Lobby', site: 'NYC-HQ', ip: '10.1.3.4', clients: 67, status: 'warning', vendor: 'mist' },
                { name: 'AP-LON-Warehouse-A', site: 'LON-Warehouse', ip: '10.2.3.1', clients: 42, status: 'online', vendor: 'meraki' },
                { name: 'AP-LON-Warehouse-B', site: 'LON-Warehouse', ip: '10.2.3.2', clients: 39, status: 'online', vendor: 'meraki' },
                { name: 'AP-LON-Office-01', site: 'LON-Warehouse', ip: '10.2.3.3', clients: 31, status: 'online', vendor: 'meraki' },
                { name: 'AP-SFO-Main', site: 'SFO-Branch', ip: '10.3.3.1', clients: 48, status: 'online', vendor: 'meraki' },
                { name: 'AP-SFO-Conf', site: 'SFO-Branch', ip: '10.3.3.2', clients: 29, status: 'online', vendor: 'meraki' },
                { name: 'AP-TOK-Sales-01', site: 'TOK-Sales', ip: '10.4.3.1', clients: 56, status: 'warning', vendor: 'mist' },
                { name: 'AP-TOK-Sales-02', site: 'TOK-Sales', ip: '10.4.3.2', clients: 44, status: 'online', vendor: 'mist' },
                { name: 'AP-MUM-Hub-01', site: 'MUM-Hub', ip: '10.5.3.1', clients: 61, status: 'online', vendor: 'meraki' },
                { name: 'AP-MUM-Hub-02', site: 'MUM-Hub', ip: '10.5.3.2', clients: 53, status: 'online', vendor: 'meraki' },
                { name: 'AP-ATL-Store', site: 'ATL-Retail', ip: '10.6.3.1', clients: 72, status: 'online', vendor: 'meraki' },
                { name: 'AP-CHI-Warehouse', site: 'CHI-Dist', ip: '10.7.3.1', clients: 37, status: 'online', vendor: 'mist' },
                { name: 'AP-CHI-Office', site: 'CHI-Dist', ip: '10.7.3.2', clients: 41, status: 'online', vendor: 'mist' },
                { name: 'AP-BER-Lab-01', site: 'BER-R&D', ip: '10.8.3.1', clients: 49, status: 'online', vendor: 'mist' },
                { name: 'AP-BER-Lab-02', site: 'BER-R&D', ip: '10.8.3.2', clients: 43, status: 'online', vendor: 'mist' },
                { name: 'AP-PAR-Main', site: 'PAR-Office', ip: '10.9.3.1', clients: 58, status: 'online', vendor: 'meraki' },
                { name: 'AP-SYD-Floor1', site: 'SYD-Office', ip: '10.10.3.1', clients: 46, status: 'online', vendor: 'mist' },
                { name: 'AP-SYD-Floor2', site: 'SYD-Office', ip: '10.10.3.2', clients: 39, status: 'online', vendor: 'mist' },
                { name: 'AP-BRA-Remote', site: 'BRA-Remote', ip: '10.11.3.1', clients: 28, status: 'critical', vendor: 'meraki' }
            ]
        };

        // --- 2. LOGIC FUNCTIONS ---

        function getFilteredData(scope, siteFilter = null) {
            // Determine if this is a site-level filter
            const isSiteFilter = siteFilter !== null;

            // Filter Charts
            const filterFn = (item) => {
                if (isSiteFilter) {
                    // Extract site name from label (e.g., "NYC-HQ (Mist)" -> "NYC-HQ")
                    const itemSite = item.label.split(' (')[0];
                    return itemSite === siteFilter;
                }
                return scope === 'Global' || item.region === scope;
            };

            const fData = frustrationData.filter(filterFn).sort((a,b) => b.val - a.val).slice(0, 5); // Top 5 highest time to connect (worst)
            const lData = latencyData.filter(filterFn).sort((a,b) => b.val - a.val).slice(0, 5); // Top 5 highest

            // Filter Alerts
            const alertFilterFn = (item) => {
                if (isSiteFilter) return item.site === siteFilter;
                return scope === 'Global' || item.region === scope;
            };
            const aData = allAlerts.filter(alertFilterFn);

            // Calculate Device Stats based on scope count
            const total = isSiteFilter ? SITES[siteFilter].deviceCount : REGIONS[scope].deviceCount;

            // Introduce slight variation per region/site for status matrix
            let critRate = 0.02;
            let warnRate = 0.04;
            if (scope === 'EMEA' || (isSiteFilter && SITE_TO_REGION[siteFilter] === 'EMEA')) {
                critRate = 0.03; warnRate = 0.06;
            }
            if (scope === 'North America' || (isSiteFilter && SITE_TO_REGION[siteFilter] === 'North America')) {
                critRate = 0.01; warnRate = 0.03;
            }

            const stats = {
                gateway: { online: Math.floor(total * 0.1 * (1-critRate-warnRate)), warn: Math.floor(total * 0.1 * warnRate), crit: Math.floor(total * 0.1 * critRate) },
                switch: { online: Math.floor(total * 0.3 * (1-critRate-warnRate)), warn: Math.floor(total * 0.3 * warnRate), crit: Math.floor(total * 0.3 * critRate) },
                ap: { online: Math.floor(total * 0.6 * (1-critRate-warnRate)), warn: Math.floor(total * 0.6 * warnRate), crit: Math.floor(total * 0.6 * critRate) }
            };

            const totalCrit = stats.gateway.crit + stats.switch.crit + stats.ap.crit;
            const totalWarn = stats.gateway.warn + stats.switch.warn + stats.ap.warn;

            // Mock Security Stats
            const threats = Math.floor(total * 0.08) + Math.floor(Math.random() * 20);
            const rogues = Math.floor(total * 0.002) + Math.floor(Math.random() * 5);

            return { fData, lData, aData, stats, totalCrit, totalWarn, threats, rogues };
        }

        function updateDashboardScope(scope) {
            // Check if this is a site-specific filter
            let isSiteScope = false;
            let siteName = null;

            if (scope.startsWith('site:')) {
                isSiteScope = true;
                siteName = scope.substring(5); // Remove 'site:' prefix
                currentScope = SITE_TO_REGION[siteName]; // Set scope to parent region
                currentSiteFilter = siteName;
            } else {
                currentScope = scope;
                currentSiteFilter = null;
            }

            const data = getFilteredData(currentScope, siteName);
            const scopeInfo = isSiteScope ? SITES[siteName] : REGIONS[currentScope];

            // 1. Update Gauge
            charts.health.data.datasets[0].data = [scopeInfo.health, 100 - scopeInfo.health];
            charts.health.data.datasets[0].backgroundColor[0] = scopeInfo.health > 90 ? '#10b981' : (scopeInfo.health > 75 ? '#f59e0b' : '#ef4444');
            charts.health.update();
            const valEl = document.getElementById('healthScoreValue');
            valEl.innerText = scopeInfo.health;
            valEl.style.color = scopeInfo.health > 90 ? '#059669' : (scopeInfo.health > 75 ? '#d97706' : '#dc2626');

            // 2. Update Big Numbers
            document.getElementById('criticalCount').innerText = data.totalCrit;
            document.getElementById('warningCount').innerText = data.totalWarn;
            document.getElementById('threatsCount').innerText = data.threats;
            document.getElementById('roguesCount').innerText = data.rogues;

            // 3. Update Clients by Device Type
            // Calculate client distribution (approximate split)
            const totalClients = scopeInfo.clientCount;
            const gwClients = Math.floor(totalClients * 0.21); // ~21% on gateways
            const swClients = Math.floor(totalClients * 0.51); // ~51% on switches
            const apClients = totalClients - gwClients - swClients; // remainder on APs

            document.getElementById('gwClientCount').innerText = gwClients.toLocaleString();
            document.getElementById('swClientCount').innerText = swClients.toLocaleString();
            document.getElementById('apClientCount').innerText = apClients.toLocaleString();

            // Set trends (vary slightly by device type)
            const baseTrend = parseFloat(scopeInfo.trend);
            document.getElementById('gwClientTrend').innerText = (baseTrend * 0.5).toFixed(1) + '%';
            document.getElementById('swClientTrend').innerText = (baseTrend * 1.2).toFixed(1) + '%';
            document.getElementById('apClientTrend').innerText = (baseTrend * 0.9).toFixed(1) + '%';

            // 4. Update WAN Donut (Mock variation)
            let fiber = 91, lte = 8, down = 1;
            const checkScope = isSiteScope ? SITE_TO_REGION[siteName] : currentScope;
            if(checkScope === 'EMEA') { fiber = 85; lte = 12; down = 3; }
            if(checkScope === 'APAC') { fiber = 94; lte = 5; down = 1; }
            charts.wan.data.datasets[0].data = [fiber, lte, down];
            charts.wan.update();
            document.getElementById('wanPrimary').innerText = fiber + '%';
            document.getElementById('wanFailover').innerText = lte + '%';
            document.getElementById('wanDown').innerText = down + '%';

            // 5. Update Frustration Chart
            // Data is already sorted descending (highest first), which displays at the top in horizontal bar charts
            charts.frustration.data.labels = data.fData.map(d => d.label);
            // Split the total time into 4 components with consistent percentages to maintain ordering
            charts.frustration.data.datasets[0].data = data.fData.map(d => {
                return Math.floor(d.val * 0.35); // 35% Association
            });
            charts.frustration.data.datasets[1].data = data.fData.map(d => {
                return Math.floor(d.val * 0.25); // 25% Auth
            });
            charts.frustration.data.datasets[2].data = data.fData.map(d => {
                return Math.floor(d.val * 0.25); // 25% DHCP
            });
            charts.frustration.data.datasets[3].data = data.fData.map(d => {
                return Math.floor(d.val * 0.15); // 15% DNS Resolution
            });
            charts.frustration.update();

            // 6. Update Latency Chart
            charts.latency.data.labels = data.lData.map(d => d.label);
            charts.latency.data.datasets[0].data = data.lData.map(d => d.val);
            charts.latency.update();

            // 7. Update Status Matrix
            document.getElementById('gw-online').innerText = data.stats.gateway.online;
            document.getElementById('gw-warn').innerText = data.stats.gateway.warn;
            document.getElementById('gw-crit').innerText = data.stats.gateway.crit;
            document.getElementById('sw-online').innerText = data.stats.switch.online;
            document.getElementById('sw-warn').innerText = data.stats.switch.warn;
            document.getElementById('sw-crit').innerText = data.stats.switch.crit;
            document.getElementById('ap-online').innerText = data.stats.ap.online;
            document.getElementById('ap-warn').innerText = data.stats.ap.warn;
            document.getElementById('ap-crit').innerText = data.stats.ap.crit;

            // 8. Update Alerts
            renderTable(currentFilter, data.aData);
        }

        // --- 3. CHART INITIALIZATION ---

        function initCharts() {
            // Initialize Chart.js defaults using shared config
            ChartConfig.initDefaults();

            // A. Health
            charts.health = new Chart(document.getElementById('healthGauge').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Health', 'Loss'],
                    datasets: [{ data: [0, 100], backgroundColor: ['#10b981', '#e5e7eb'], borderWidth: 0, circumference: 180, rotation: 270, cutout: '85%', borderRadius: 5 }]
                },
                options: { plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });

            // B. Frustration
            const frustrationCanvas = document.getElementById('frustrationChart');
            charts.frustration = new Chart(frustrationCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Association', data: [], backgroundColor: '#dc2626', borderRadius: 4 },
                        { label: 'Auth', data: [], backgroundColor: '#ea580c', borderRadius: 4 },
                        { label: 'DHCP', data: [], backgroundColor: '#f59e0b', borderRadius: 4 },
                        { label: 'DNS Resolution', data: [], backgroundColor: '#16a34a', borderRadius: 4 }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    onClick: (event, elements, chart) => {
                        // Only filter if clicking on a bar, not legend
                        if (elements.length > 0 && elements[0].datasetIndex !== undefined) {
                            const index = elements[0].index;
                            const siteName = chart.data.labels[index];
                            filterBySite(siteName);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 10 }
                            },
                            onClick: () => {} // Disable legend click
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' (click to filter)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { display: true, borderDash: [2, 2] },
                            title: { display: true, text: 'Time (ms)', font: { size: 10 } }
                        },
                        y: {
                            stacked: true,
                            grid: { display: false }
                        }
                    }
                }
            });

            // C. Latency
            const latencyCanvas = document.getElementById('latencyChart');
            charts.latency = new Chart(latencyCanvas.getContext('2d'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Latency (ms)', data: [], backgroundColor: '#6366f1', borderRadius: 4 }] },
                options: {
                    indexAxis: 'y',
                    onClick: (event, elements, chart) => {
                        // Only filter if clicking on a bar
                        if (elements.length > 0 && elements[0].datasetIndex !== undefined) {
                            const index = elements[0].index;
                            const siteName = chart.data.labels[index];
                            filterBySite(siteName);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' (click to filter)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: true, borderDash: [2, 2] } },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // D. WAN
            charts.wan = new Chart(document.getElementById('wanDonut').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Primary', 'Backup', 'Down'],
                    datasets: [{ data: [91, 8, 1], backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'], borderWidth: 0, cutout: '70%' }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // E. Sparklines for each device type
            charts.gwSpark = new Chart(document.getElementById('gwSparkline').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['6h', '5h', '4h', '3h', '2h', '1h', 'Now'],
                    datasets: [{ data: [3000, 3050, 3100, 3150, 3180, 3190, 3200], borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, pointRadius: 0 }]
                },
                options: { plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
            });

            charts.swSpark = new Chart(document.getElementById('swSparkline').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['6h', '5h', '4h', '3h', '2h', '1h', 'Now'],
                    datasets: [{ data: [7200, 7300, 7450, 7600, 7700, 7750, 7800], borderColor: '#9333ea', borderWidth: 2, tension: 0.4, pointRadius: 0 }]
                },
                options: { plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
            });

            charts.apSpark = new Chart(document.getElementById('apSparkline').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['6h', '5h', '4h', '3h', '2h', '1h', 'Now'],
                    datasets: [{ data: [4050, 4100, 4150, 4200, 4280, 4310, 4342], borderColor: '#16a34a', borderWidth: 2, tension: 0.4, pointRadius: 0 }]
                },
                options: { plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        // --- 4. ALERT TABLE LOGIC ---

        const sevStyles = {
            crit: 'text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-400 rounded-full px-2 py-0.5 text-xs font-bold border border-red-100 dark:border-red-900',
            warn: 'text-amber-600 bg-amber-50 dark:bg-amber-900/20 dark:text-amber-400 rounded-full px-2 py-0.5 text-xs font-bold border border-amber-100 dark:border-amber-900',
            info: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20 dark:text-blue-400 rounded-full px-2 py-0.5 text-xs font-bold border border-blue-100 dark:border-blue-900'
        };

        const sevIcons = {
            crit: '<i class="fa-solid fa-circle-exclamation"></i>',
            warn: '<i class="fa-solid fa-triangle-exclamation"></i>',
            info: '<i class="fa-solid fa-circle-info"></i>'
        };

        function renderTable(filter, alertsOverride = null) {
            const tableBody = document.getElementById('alertTableBody');
            tableBody.innerHTML = '';

            // Determine active alerts source (current scope vs passed override)
            let alertsToFilter = alertsOverride || getFilteredData(currentScope).aData;

            const badge = document.getElementById('activeFilterBadge');
            // Determine what badges to show
            let badgeText = '';
            if (currentSiteFilter) {
                badgeText = `Site: ${currentSiteFilter}`;
            }
            if (filter !== 'all') {
                if (badgeText) badgeText += ' | ';
                if (filter === 'fires') badgeText += 'Active Fires';
                if (filter === 'threat') badgeText += 'Security Threats';
                if (filter === 'rogue') badgeText += 'Rogue Devices';
            }

            if (badgeText) {
                badge.classList.remove('hidden');
                badge.textContent = badgeText;
            } else {
                badge.classList.add('hidden');
                badge.textContent = '';
            }

            const filteredAlerts = alertsToFilter.filter(a => {
                // Apply alert type filter (site filter already applied in getFilteredData)
                if (filter === 'all') return true;
                if (filter === 'fires') return a.sev === 'crit' || a.sev === 'warn';
                if (filter === 'threat') return a.type === 'threat';
                if (filter === 'rogue') return a.type === 'rogue';
                return true;
            });

            if (filteredAlerts.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td colspan="6" class="px-6 py-4 text-center text-sm text-gray-400">No alerts found for this criteria in ${currentScope}.</td>`;
                 tableBody.appendChild(row);
                 return;
            }

            filteredAlerts.forEach(alert => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${sevStyles[alert.sev]} flex items-center gap-1 w-fit">
                            ${sevIcons[alert.sev]} ${alert.sev.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">${alert.time}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-2">
                            ${alert.vendor === 'meraki'
                                ? '<img src="images/cisco-logo.svg" class="h-4 w-auto opacity-70" alt="Meraki">'
                                : '<img src="images/juniper-logo.svg" class="h-3 w-auto opacity-70" alt="Mist">'}
                            <span class="capitalize text-xs font-medium">${alert.vendor}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${alert.site}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium hover:underline">${alert.device}</a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs" title="${alert.msg}">${alert.msg}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Action Handlers
        function filterAlerts(type) {
            // If clicking the same filter, toggle off
            if (currentFilter === type) {
                currentFilter = 'all';
            } else {
                currentFilter = type;
            }

            renderTable(currentFilter);
        }

        function filterBySite(siteName) {
            // Extract site name without vendor info (e.g., "NYC-HQ (Mist)" -> "NYC-HQ")
            const cleanSiteName = siteName.split(' (')[0];

            // Toggle site filter
            if (currentSiteFilter === cleanSiteName) {
                // Clear filter - go back to global
                currentSiteFilter = null;
                document.getElementById('scopeSelector').value = 'Global';
                updateDashboardScope('Global');
            } else {
                // Apply site filter
                document.getElementById('scopeSelector').value = 'site:' + cleanSiteName;
                updateDashboardScope('site:' + cleanSiteName);
            }
        }

        // --- DEVICE LIST FUNCTIONS ---

        function closeExpandedWidgets() {
            if (isExpanded) {
                toggleExpand();
            }
            if (isStatusExpanded) {
                hideStatusDevices();
            }
            if (isIssuesExpanded) {
                hideIssuesAlerts();
            }
            if (isSecurityExpanded) {
                hideSecurityAlerts();
            }
        }

        function toggleExpand() {
            const card = document.getElementById('activeClientsCard');
            const icon = document.querySelector('#expandToggle i');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            if (!isExpanded) {
                // Close status widget if it's open
                if (isStatusExpanded) {
                    hideStatusDevices();
                }

                // Expand to overlay mode
                card.classList.add('expanded');
                backdrop.classList.add('active');
                mainContent.style.overflow = 'hidden';
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                isExpanded = true;

                // Show all devices by default when expanding
                showDeviceList('all');
            } else {
                // Collapse back to normal
                card.classList.remove('expanded');
                backdrop.classList.remove('active');
                mainContent.style.overflow = '';
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                isExpanded = false;
                hideDeviceList();
            }
        }

        function showDeviceList(deviceType) {
            const summaryView = document.getElementById('summaryView');
            const expandedView = document.getElementById('expandedView');
            const card = document.getElementById('activeClientsCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // If not already expanded, expand the card first
            if (!isExpanded) {
                card.classList.add('expanded');
                backdrop.classList.add('active');
                mainContent.style.overflow = 'hidden';
                const icon = document.querySelector('#expandToggle i');
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                isExpanded = true;
            }

            summaryView.classList.add('hidden');
            expandedView.classList.remove('hidden');

            // Update title
            const titles = {
                'gateway': 'Gateway Devices',
                'switch': 'Switch Devices',
                'ap': 'Access Point Devices',
                'all': 'All Devices'
            };
            document.getElementById('deviceListTitle').innerText = titles[deviceType] || 'Devices';

            // Set initial filter
            currentDeviceFilter = deviceType;
            updateDeviceFilterButtons(deviceType);
            renderDeviceList(deviceType);
        }

        function hideDeviceList() {
            const summaryView = document.getElementById('summaryView');
            const expandedView = document.getElementById('expandedView');

            summaryView.classList.remove('hidden');
            expandedView.classList.add('hidden');
        }

        function filterDevices(deviceType) {
            currentDeviceFilter = deviceType;
            updateDeviceFilterButtons(deviceType);
            renderDeviceList(deviceType);
        }

        function searchDeviceList() {
            clientsSearchTerm = document.getElementById('clientsSearchInput').value;
            renderDeviceList(currentDeviceFilter);
        }

        function updateDeviceFilterButtons(activeFilter) {
            // Reset all buttons
            const buttons = ['filterAll', 'filterGateway', 'filterSwitch', 'filterAp'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.className = 'px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
            });

            // Activate selected button
            const activeMap = {
                'all': 'filterAll',
                'gateway': 'filterGateway',
                'switch': 'filterSwitch',
                'ap': 'filterAp'
            };

            const activeBtn = document.getElementById(activeMap[activeFilter]);
            if (activeBtn) {
                activeBtn.className = 'px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors';
            }
        }

        function renderDeviceList(deviceType) {
            const container = document.getElementById('deviceListContainer');
            const deviceCountEl = document.getElementById('deviceCount');
            container.innerHTML = '';

            // Gather devices based on filter
            let devices = [];
            if (deviceType === 'all') {
                devices = [...MOCK_DEVICES.gateway, ...MOCK_DEVICES.switch, ...MOCK_DEVICES.ap];
            } else {
                devices = MOCK_DEVICES[deviceType] || [];
            }

            // Apply site filter if active
            if (currentSiteFilter) {
                devices = devices.filter(d => d.site === currentSiteFilter);
            }

            // Apply search filter
            if (clientsSearchTerm) {
                const searchLower = clientsSearchTerm.toLowerCase();
                devices = devices.filter(d =>
                    d.name.toLowerCase().includes(searchLower) ||
                    d.site.toLowerCase().includes(searchLower) ||
                    d.ip.toLowerCase().includes(searchLower)
                );
            }

            // Sort by clients (descending)
            devices.sort((a, b) => b.clients - a.clients);

            // Update device count
            deviceCountEl.innerText = `${devices.length} device${devices.length !== 1 ? 's' : ''}`;

            // Render device cards
            devices.forEach(device => {
                const statusColors = {
                    'online': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
                    'warning': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                    'critical': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
                };

                const statusIcons = {
                    'online': 'fa-circle-check',
                    'warning': 'fa-circle-exclamation',
                    'critical': 'fa-circle-xmark'
                };

                const deviceTypeIcons = {
                    'GW-': { icon: 'fa-network-wired', color: 'text-blue-600 dark:text-blue-400' },
                    'SW-': { icon: 'fa-server', color: 'text-purple-600 dark:text-purple-400' },
                    'AP-': { icon: 'fa-wifi', color: 'text-green-600 dark:text-green-400' }
                };

                const prefix = device.name.substring(0, 3);
                const iconInfo = deviceTypeIcons[prefix] || { icon: 'fa-circle', color: 'text-gray-600' };

                const deviceCard = document.createElement('div');
                deviceCard.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-xl hover:shadow-md hover:bg-white dark:hover:bg-gray-700 transition-all duration-200 cursor-pointer border border-transparent hover:border-blue-200 dark:hover:border-blue-800';
                deviceCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-gray-900 flex items-center justify-center shadow-sm">
                                <i class="fa-solid ${iconInfo.icon} ${iconInfo.color} text-lg"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-900 dark:text-white truncate mb-0.5">${device.name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${device.site}</div>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-[10px] rounded-lg font-semibold ${statusColors[device.status]} flex items-center gap-1">
                            <i class="fa-solid ${statusIcons[device.status]}"></i>
                            ${device.status.toUpperCase()}
                        </span>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                            <i class="fa-solid fa-network-wired text-[10px]"></i>
                            <span>${device.ip}</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-users text-blue-600 dark:text-blue-400 text-xs"></i>
                            <span class="text-sm font-bold text-gray-900 dark:text-white">${device.clients}</span>
                            <span class="text-[10px] text-gray-500 dark:text-gray-400">clients</span>
                        </div>
                    </div>
                `;
                container.appendChild(deviceCard);
            });

            // Show "no devices" message if empty
            if (devices.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-sm text-gray-400 py-12">No devices found</div>';
            }
        }

        // --- STATUS WIDGET FUNCTIONS ---

        function showStatusDevices(deviceType, status) {
            // Close Active Clients widget if it's open
            if (isExpanded) {
                const clientsCard = document.getElementById('activeClientsCard');
                const clientsIcon = document.querySelector('#expandToggle i');
                clientsCard.classList.remove('expanded');
                clientsIcon.classList.remove('fa-compress');
                clientsIcon.classList.add('fa-expand');
                isExpanded = false;
                document.getElementById('summaryView').classList.remove('hidden');
                document.getElementById('expandedView').classList.add('hidden');
            }

            const statusSummaryView = document.getElementById('statusSummaryView');
            const statusExpandedView = document.getElementById('statusExpandedView');
            const card = document.getElementById('deviceStatusCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Expand the card to overlay mode
            card.classList.add('expanded');
            backdrop.classList.add('active');
            mainContent.style.overflow = 'hidden';
            isStatusExpanded = true;

            statusSummaryView.classList.add('hidden');
            statusExpandedView.classList.remove('hidden');

            // Set the filters
            currentStatusDeviceType = deviceType;
            currentStatusFilter = status;

            // Update title
            const deviceTypeNames = {
                'gateway': 'Gateway',
                'switch': 'Switch',
                'ap': 'Access Point'
            };
            const statusNames = {
                'online': 'Online',
                'warning': 'Warning',
                'critical': 'Critical'
            };

            document.getElementById('statusDeviceListTitle').innerText =
                `${statusNames[status]} ${deviceTypeNames[deviceType]} Devices`;

            updateStatusFilterButtons(status);
            renderStatusDeviceList();
        }

        function hideStatusDevices() {
            const statusSummaryView = document.getElementById('statusSummaryView');
            const statusExpandedView = document.getElementById('statusExpandedView');
            const card = document.getElementById('deviceStatusCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Collapse back
            card.classList.remove('expanded');
            backdrop.classList.remove('active');
            mainContent.style.overflow = '';
            isStatusExpanded = false;

            statusSummaryView.classList.remove('hidden');
            statusExpandedView.classList.add('hidden');
        }

        function filterStatusDevices(status) {
            currentStatusFilter = status;
            updateStatusFilterButtons(status);
            renderStatusDeviceList();
        }

        function searchStatusDevices() {
            statusSearchTerm = document.getElementById('statusSearchInput').value;
            renderStatusDeviceList();
        }

        function updateStatusFilterButtons(activeFilter) {
            // Reset all buttons
            const buttons = ['statusFilterAll', 'statusFilterOnline', 'statusFilterWarning', 'statusFilterCritical'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.className = 'px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
            });

            // Activate selected button
            const activeMap = {
                'all': 'statusFilterAll',
                'online': 'statusFilterOnline',
                'warning': 'statusFilterWarning',
                'critical': 'statusFilterCritical'
            };

            const activeBtn = document.getElementById(activeMap[activeFilter]);
            if (activeBtn) {
                activeBtn.className = 'px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors';
            }
        }

        function renderStatusDeviceList() {
            const container = document.getElementById('statusDeviceListContainer');
            const deviceCountEl = document.getElementById('statusDeviceCount');
            container.innerHTML = '';

            // Get devices based on type
            let devices = [];
            if (currentStatusDeviceType === 'all') {
                devices = [...MOCK_DEVICES.gateway, ...MOCK_DEVICES.switch, ...MOCK_DEVICES.ap];
            } else {
                devices = MOCK_DEVICES[currentStatusDeviceType] || [];
            }

            // Apply site filter if active
            if (currentSiteFilter) {
                devices = devices.filter(d => d.site === currentSiteFilter);
            }

            // Apply status filter
            if (currentStatusFilter !== 'all') {
                devices = devices.filter(d => d.status === currentStatusFilter);
            }

            // Apply search filter
            if (statusSearchTerm) {
                const searchLower = statusSearchTerm.toLowerCase();
                devices = devices.filter(d =>
                    d.name.toLowerCase().includes(searchLower) ||
                    d.site.toLowerCase().includes(searchLower) ||
                    d.ip.toLowerCase().includes(searchLower)
                );
            }

            // Sort by clients (descending)
            devices.sort((a, b) => b.clients - a.clients);

            // Update device count
            deviceCountEl.innerText = `${devices.length} device${devices.length !== 1 ? 's' : ''}`;

            // Render device cards (reuse the same rendering logic)
            devices.forEach(device => {
                const statusColors = {
                    'online': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
                    'warning': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                    'critical': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
                };

                const statusIcons = {
                    'online': 'fa-circle-check',
                    'warning': 'fa-circle-exclamation',
                    'critical': 'fa-circle-xmark'
                };

                const deviceTypeIcons = {
                    'GW-': { icon: 'fa-network-wired', color: 'text-blue-600 dark:text-blue-400' },
                    'SW-': { icon: 'fa-server', color: 'text-purple-600 dark:text-purple-400' },
                    'AP-': { icon: 'fa-wifi', color: 'text-green-600 dark:text-green-400' }
                };

                const prefix = device.name.substring(0, 3);
                const iconInfo = deviceTypeIcons[prefix] || { icon: 'fa-circle', color: 'text-gray-600' };

                const deviceCard = document.createElement('div');
                deviceCard.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-xl hover:shadow-md hover:bg-white dark:hover:bg-gray-700 transition-all duration-200 cursor-pointer border border-transparent hover:border-blue-200 dark:hover:border-blue-800';
                deviceCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-gray-900 flex items-center justify-center shadow-sm">
                                <i class="fa-solid ${iconInfo.icon} ${iconInfo.color} text-lg"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-900 dark:text-white truncate mb-0.5">${device.name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${device.site}</div>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-[10px] rounded-lg font-semibold ${statusColors[device.status]} flex items-center gap-1">
                            <i class="fa-solid ${statusIcons[device.status]}"></i>
                            ${device.status.toUpperCase()}
                        </span>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                            <i class="fa-solid fa-network-wired text-[10px]"></i>
                            <span>${device.ip}</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-users text-blue-600 dark:text-blue-400 text-xs"></i>
                            <span class="text-sm font-bold text-gray-900 dark:text-white">${device.clients}</span>
                            <span class="text-[10px] text-gray-500 dark:text-gray-400">clients</span>
                        </div>
                    </div>
                `;
                container.appendChild(deviceCard);
            });

            // Show "no devices" message if empty
            if (devices.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-sm text-gray-400 py-12">No devices found</div>';
            }
        }

        // --- NETWORK ISSUES WIDGET FUNCTIONS ---

        function showIssuesAlerts(severity) {
            // Close other widgets if open
            if (isExpanded) {
                const clientsCard = document.getElementById('activeClientsCard');
                const clientsIcon = document.querySelector('#expandToggle i');
                clientsCard.classList.remove('expanded');
                clientsIcon.classList.remove('fa-compress');
                clientsIcon.classList.add('fa-expand');
                isExpanded = false;
                document.getElementById('summaryView').classList.remove('hidden');
                document.getElementById('expandedView').classList.add('hidden');
            }
            if (isStatusExpanded) {
                const statusCard = document.getElementById('deviceStatusCard');
                statusCard.classList.remove('expanded');
                isStatusExpanded = false;
                document.getElementById('statusSummaryView').classList.remove('hidden');
                document.getElementById('statusExpandedView').classList.add('hidden');
            }

            const issuesSummaryView = document.getElementById('issuesSummaryView');
            const issuesExpandedView = document.getElementById('issuesExpandedView');
            const card = document.getElementById('networkIssuesCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Expand the card to overlay mode
            card.classList.add('expanded');
            backdrop.classList.add('active');
            mainContent.style.overflow = 'hidden';
            isIssuesExpanded = true;

            issuesSummaryView.classList.add('hidden');
            issuesExpandedView.classList.remove('hidden');

            // Set the filter
            currentIssuesSeverity = severity;

            // Update title
            const severityNames = {
                'crit': 'Critical',
                'warn': 'Warning',
                'info': 'Info',
                'all': 'All'
            };

            document.getElementById('issuesAlertTitle').innerText = `${severityNames[severity]} Network Alerts`;

            updateIssuesFilterButtons(severity);
            renderIssuesAlertTable();
        }

        function hideIssuesAlerts() {
            const issuesSummaryView = document.getElementById('issuesSummaryView');
            const issuesExpandedView = document.getElementById('issuesExpandedView');
            const card = document.getElementById('networkIssuesCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Collapse back
            card.classList.remove('expanded');
            backdrop.classList.remove('active');
            mainContent.style.overflow = '';
            isIssuesExpanded = false;

            issuesSummaryView.classList.remove('hidden');
            issuesExpandedView.classList.add('hidden');
        }

        function filterIssuesAlerts(severity) {
            currentIssuesSeverity = severity;
            updateIssuesFilterButtons(severity);
            renderIssuesAlertTable();
        }

        function updateIssuesFilterButtons(activeFilter) {
            // Reset all buttons
            const buttons = ['issuesFilterAll', 'issuesFilterCrit', 'issuesFilterWarn', 'issuesFilterInfo'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.className = 'px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
            });

            // Activate selected button
            const activeMap = {
                'all': 'issuesFilterAll',
                'crit': 'issuesFilterCrit',
                'warn': 'issuesFilterWarn',
                'info': 'issuesFilterInfo'
            };

            const activeBtn = document.getElementById(activeMap[activeFilter]);
            if (activeBtn) {
                activeBtn.className = 'px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors';
            }
        }

        function renderIssuesAlertTable() {
            const tableBody = document.getElementById('issuesAlertTableBody');
            const alertCountEl = document.getElementById('issuesAlertCount');
            tableBody.innerHTML = '';

            // Get alerts from current scope
            const data = getFilteredData(currentScope, currentSiteFilter);
            let alerts = data.aData;

            // Apply severity filter
            if (currentIssuesSeverity !== 'all') {
                alerts = alerts.filter(a => a.sev === currentIssuesSeverity);
            }

            // Apply search filter
            if (issuesSearchTerm) {
                const searchLower = issuesSearchTerm.toLowerCase();
                alerts = alerts.filter(a =>
                    a.site.toLowerCase().includes(searchLower) ||
                    a.device.toLowerCase().includes(searchLower) ||
                    a.msg.toLowerCase().includes(searchLower)
                );
            }

            // Update alert count
            alertCountEl.innerText = `${alerts.length} alert${alerts.length !== 1 ? 's' : ''}`;

            if (alerts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="px-4 py-4 text-center text-sm text-gray-400">No alerts found for this criteria.</td>`;
                tableBody.appendChild(row);
                return;
            }

            const sevStyles = {
                crit: 'text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-400 rounded-full px-2 py-0.5 text-xs font-bold border border-red-100 dark:border-red-900',
                warn: 'text-amber-600 bg-amber-50 dark:bg-amber-900/20 dark:text-amber-400 rounded-full px-2 py-0.5 text-xs font-bold border border-amber-100 dark:border-amber-900',
                info: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20 dark:text-blue-400 rounded-full px-2 py-0.5 text-xs font-bold border border-blue-100 dark:border-blue-900'
            };

            const sevIcons = {
                crit: '<i class="fa-solid fa-circle-exclamation"></i>',
                warn: '<i class="fa-solid fa-triangle-exclamation"></i>',
                info: '<i class="fa-solid fa-circle-info"></i>'
            };

            alerts.forEach(alert => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors";
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="${sevStyles[alert.sev]} flex items-center gap-1 w-fit">
                            ${sevIcons[alert.sev]} ${alert.sev.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">${alert.time}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${alert.site}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium hover:underline">${alert.device}</a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs" title="${alert.msg}">${alert.msg}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function searchIssuesAlerts() {
            issuesSearchTerm = document.getElementById('issuesSearchInput').value;
            renderIssuesAlertTable();
        }

        // --- SECURITY POSTURE WIDGET FUNCTIONS ---

        function showSecurityAlerts(securityType) {
            // Close other widgets if open
            if (isExpanded) {
                const clientsCard = document.getElementById('activeClientsCard');
                const clientsIcon = document.querySelector('#expandToggle i');
                clientsCard.classList.remove('expanded');
                clientsIcon.classList.remove('fa-compress');
                clientsIcon.classList.add('fa-expand');
                isExpanded = false;
                document.getElementById('summaryView').classList.remove('hidden');
                document.getElementById('expandedView').classList.add('hidden');
            }
            if (isStatusExpanded) {
                const statusCard = document.getElementById('deviceStatusCard');
                statusCard.classList.remove('expanded');
                isStatusExpanded = false;
                document.getElementById('statusSummaryView').classList.remove('hidden');
                document.getElementById('statusExpandedView').classList.add('hidden');
            }
            if (isIssuesExpanded) {
                const issuesCard = document.getElementById('networkIssuesCard');
                issuesCard.classList.remove('expanded');
                isIssuesExpanded = false;
                document.getElementById('issuesSummaryView').classList.remove('hidden');
                document.getElementById('issuesExpandedView').classList.add('hidden');
            }

            const securitySummaryView = document.getElementById('securitySummaryView');
            const securityExpandedView = document.getElementById('securityExpandedView');
            const card = document.getElementById('securityCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Expand the card to overlay mode
            card.classList.add('expanded');
            backdrop.classList.add('active');
            mainContent.style.overflow = 'hidden';
            isSecurityExpanded = true;

            securitySummaryView.classList.add('hidden');
            securityExpandedView.classList.remove('hidden');

            // Set the filter
            currentSecurityType = securityType;

            // Update title
            const typeNames = {
                'threat': 'Threat',
                'rogue': 'Rogue Device',
                'all': 'Security'
            };

            document.getElementById('securityAlertTitle').innerText = `${typeNames[securityType]} Alerts`;

            updateSecurityFilterButtons(securityType);
            renderSecurityAlertTable();
        }

        function hideSecurityAlerts() {
            const securitySummaryView = document.getElementById('securitySummaryView');
            const securityExpandedView = document.getElementById('securityExpandedView');
            const card = document.getElementById('securityCard');
            const backdrop = document.getElementById('expandedBackdrop');
            const mainContent = document.querySelector('main');

            // Collapse back
            card.classList.remove('expanded');
            backdrop.classList.remove('active');
            mainContent.style.overflow = '';
            isSecurityExpanded = false;

            securitySummaryView.classList.remove('hidden');
            securityExpandedView.classList.add('hidden');
        }

        function filterSecurityAlerts(securityType) {
            currentSecurityType = securityType;
            updateSecurityFilterButtons(securityType);
            renderSecurityAlertTable();
        }

        function updateSecurityFilterButtons(activeFilter) {
            // Reset all buttons
            const buttons = ['securityFilterAll', 'securityFilterThreat', 'securityFilterRogue'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.className = 'px-3 py-1.5 text-xs rounded-lg bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
            });

            // Activate selected button
            const activeMap = {
                'all': 'securityFilterAll',
                'threat': 'securityFilterThreat',
                'rogue': 'securityFilterRogue'
            };

            const activeBtn = document.getElementById(activeMap[activeFilter]);
            if (activeBtn) {
                activeBtn.className = 'px-3 py-1.5 text-xs rounded-lg bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 font-medium hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors';
            }
        }

        function renderSecurityAlertTable() {
            const tableBody = document.getElementById('securityAlertTableBody');
            const alertCountEl = document.getElementById('securityAlertCount');
            tableBody.innerHTML = '';

            // Get alerts from current scope
            const data = getFilteredData(currentScope, currentSiteFilter);
            let alerts = data.aData;

            // Apply security type filter
            if (currentSecurityType !== 'all') {
                alerts = alerts.filter(a => a.type === currentSecurityType);
            } else {
                // Show only security-related alerts (threats and rogues)
                alerts = alerts.filter(a => a.type === 'threat' || a.type === 'rogue');
            }

            // Apply search filter
            if (securitySearchTerm) {
                const searchLower = securitySearchTerm.toLowerCase();
                alerts = alerts.filter(a =>
                    a.site.toLowerCase().includes(searchLower) ||
                    a.device.toLowerCase().includes(searchLower) ||
                    a.msg.toLowerCase().includes(searchLower)
                );
            }

            // Update alert count
            alertCountEl.innerText = `${alerts.length} alert${alerts.length !== 1 ? 's' : ''}`;

            if (alerts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="px-4 py-4 text-center text-sm text-gray-400">No security alerts found for this criteria.</td>`;
                tableBody.appendChild(row);
                return;
            }

            const typeStyles = {
                threat: 'text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 dark:text-indigo-400 rounded-full px-2 py-0.5 text-xs font-bold border border-indigo-100 dark:border-indigo-900',
                rogue: 'text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-400 rounded-full px-2 py-0.5 text-xs font-bold border border-red-100 dark:border-red-900'
            };

            const typeIcons = {
                threat: '<i class="fa-solid fa-shield-halved"></i>',
                rogue: '<i class="fa-solid fa-wifi"></i>'
            };

            const typeLabels = {
                threat: 'THREAT',
                rogue: 'ROGUE'
            };

            alerts.forEach(alert => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors";
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="${typeStyles[alert.type]} flex items-center gap-1 w-fit">
                            ${typeIcons[alert.type]} ${typeLabels[alert.type]}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500 dark:text-gray-400">${alert.time}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${alert.site}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium hover:underline">${alert.device}</a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 truncate max-w-xs" title="${alert.msg}">${alert.msg}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function searchSecurityAlerts() {
            securitySearchTerm = document.getElementById('securitySearchInput').value;
            renderSecurityAlertTable();
        }

        // Initialize
        initCharts();
        updateDashboardScope('Global'); // Load Global Data initially

        // Register charts with theme manager for automatic theme updates
        themeManager.registerCharts(charts);

        // Update chart colors after initialization if dark mode is already active
        if (themeManager.isDarkMode()) {
            themeManager.updateChartColors();
        }

    </script>
</body>
</html>